name: Deploy to cPanel (Laravel + Vite)

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ Checkout code
    - name: üöö Checkout code
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Setup PHP
    - name: üü¢ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, pdo, pdo_mysql, zip, intl, gd
        coverage: none

    # 3Ô∏è‚É£ Install Composer dependencies
    - name: üéº Install Composer dependencies
      run: |
        composer install --no-dev --optimize-autoloader --no-interaction

    # 4Ô∏è‚É£ Setup Node.js
    - name: üü¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    # 5Ô∏è‚É£ Build Vite assets
    - name: ‚ö° Build Vite assets
      run: |
        npm ci
        npm run build

    # 6Ô∏è‚É£ Setup SSH
    - name: üîê Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

    # 7Ô∏è‚É£ Deploy files using rsync (MOST STABLE)
    - name: üìÇ Deploy via rsync
      run: |
        rsync -az --delete \
          --exclude=".git/" \
          --exclude=".github/" \
          --exclude="node_modules/" \
          --exclude="tests/" \
          --exclude=".env" \
          ./ \
          ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/qhxrmvtx/public_html/devlop.teamtasktrack.com/

    # 8Ô∏è‚É£ Run Laravel commands on server
    - name: üöÄ Run Artisan commands
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          cd /home/qhxrmvtx/public_html/devlop.teamtasktrack.com
          php artisan migrate --force
          php artisan storage:link || true
          php artisan optimize:clear
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
